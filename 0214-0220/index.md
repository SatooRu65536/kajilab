# BLEビーコンと触れ合ってみた

## 出席率
- 3年セミナー：??%

## スケジュール
### 短期的な予定
- [ ] mocopi と お料理センシング
    - [x] シーンとランドマークを決める
    - [x] SVM で動作判別する
    - [ ] 機械学習を深める
        - [ ] データセットを探す
        - [ ] 機械学習する
        - [ ] ?
    - [ ] お料理センシング
        - [ ] お料理でどんな動作があるかを知る
        - [ ] ?
    - [ ] 論文書く
    - [ ] 発表
- [ ] BLEビーコンと触れ合う
    - [x] uuid を取得する
    - [x] 通信内容を見てみる
    - [ ] アプリ以外からuuidを変更する

### 長期的な予定
- ~?月 シーン検知?をする
- ~?月 論文を書く
- ~?月 論文発表したい


## 進捗報告
## BLEビーコンと触れ合った
やりたいことは機械学習なのか...? と思い一旦BLEビーコンを触ってみた

togawaさんからビーコンを貰った
> 物理ビーコンはuuidが変わらないからセキュリティが微妙
> 専用のアプリを使えば uuid を変えることができるからどうにかすればできるかも

### BLEを拾ってみる
GitHub `kajiLabTeam/stay-watch-reciever` を見てみた
`bluepy` を使っていた

> pip install bluepy

エラー吐いた
Bluetooth関連はネイティブに依存しているがMacOSにはライブラリが入っていないぽい

簡単に MacOS, RasPi に対応できる `bleak` を使った
```python
import asyncio
from bleak import BleakScanner

async def main():
    devices = await BleakScanner.discover()
    [print(d.address) for d in devices]

asyncio.run(main())
```
簡単にできた


### Bluetooth通信の内容を取得する
アプリ以外からのuuid等の変更ができるのか気になっていたので試してみる

togawaさんの今後の研究かもしれない → 問題ないとのことでした

[nRF51822搭載 Bluefruit LE Sniffer](https://www.sengoku.co.jp/mod/sgk_cart/detail.php?code=EEHD-56KT)
これとWiresharkを使うとBLE通信をキャプチャできるらしい
→ 5000円はすぐには出せないため他のやり方を探す
<img width="230" alt="de129fac3384eae4e37670c3ef239f16e2645451623b60b5eff3ff03d86af536.jpg (13.5 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/18/148142/dc391148-6e0e-4d5d-8d52-91974f6ddfa9.jpg">


Android なら簡単に取り出せるらしい
Android の adb と言うツールで バグレポートを生成し、取得
参考: [AndroidアプリとデバイスとのBluetoothでの通信内容を解析する
](https://luckypines.com/blog/2019-05-12_Android----------Bluetooth------------5844e20b5b98/)

通信内容の一つ
タイムスタンプがあった
<img width="1262" alt="スクリーンショット 2024-02-16 1.47.37.png (644.3 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/f0033bd7-4aaf-4d1c-ade2-db273ec32209.png">

この流れでやった
```
1:41:00　パスワード送信
1:41:06　接続
1:42:50　uuid変更 セーブ
1:42:55　セーブ完了
1:43:32　adb bugreport
```

プロトコルとか何もしらないけど一旦みてみる

`1:41:00` 頃から `FeasycomTech...` から通信しているのが見える
※ 使用したBLEビーコン・設定アプリの会社がfeasycom
<img width="1519" alt="スクリーンショット 2024-02-16 1.52.30.png (1.3 MB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/dbf143f3-0368-41ce-b444-000de1fa690d.png">

uuid を見つけた！確実にビーコンと通信している
<img width="1262" alt="スクリーンショット 2024-02-16 1.54.33.png (680.1 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/4d2adac0-16be-4333-810b-4c7a245e3767.png">

#### パケット総当たりは大変そうなのでプロトコルを調べてみる
HCL_EVTプロトコル
> Host Controller Interface なので、自身のBluetoothコントローラとの通信するやつ
[Bluetoothのパケットキャプチャ](https://scrapbox.io/unarist/Bluetooth%E3%81%AE%E3%83%91%E3%82%B1%E3%83%83%E3%83%88%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3)

ATTプロトコル
>サーバとクライアントはそれぞれAttribute（属性）データを持っており、双方の確認のためにその属性のやり取りをするプロトコルがATTプロトコルです。Attributeは、それがどの様な機能やデータを持つものであるかを示しています。これはClient-Serverアーキテクチャのための、クライアントとサーバ間の一対一の通信プロトコルです。また、ATTプロトコルは双方の属性を確認するためのプロトコルなので、例えば温度測定デバイスのデータそのものを読み込むなどの動作は含んでいません。センサのデータを読み込むなどするには、一段上のレイヤのGATTが必要になります
https://techweb.rohm.co.jp/product/wireless/bluetooth/bluetooth-basic/3225/

よくわからないけど ATT を見れば良さそう

<img width="450" alt="BT_4_ps.gif (28.0 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/532a1956-ab7d-472b-acde-3313167e9e99.gif">


### BLEについて解説してるサイトを見つけたから読んでみる
[Tech Web](https://techweb.rohm.co.jp/product/wireless/bluetooth/bluetooth-basic/3225/)

#### ATTプロトコルのPUDと概略
<img width="1068" alt="スクリーンショット 2024-02-16 3.02.34.png (650.1 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/681ad351-2f3e-4ab6-bbf9-cd5541bcfa5d.png">

OpCodeで判別しているらしい
実際の通信にもあった。これはエラーを返しているぽい
<img width="696" alt="スクリーンショット 2024-02-16 3.00.36.png (132.6 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/a4f64e34-f1f0-42ab-9ecb-598ab3634ef1.png">

### 一例
> 0x0111 ~ 0x0024 くれ [Feb 16, 2024 01:41:04.654316000 JST]
<img width="692" alt="スクリーンショット 2024-02-16 3.18.23.png (151.9 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/61908fa4-ad6b-4d8d-9475-308ec5989dbe.png">

> 0x0111 ~ 0x0024 あげるよ [Feb 16, 2024 01:41:04.683529000 JST]
<img width="692" alt="スクリーンショット 2024-02-16 3.19.50.png (205.5 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/7dd987cc-2caf-4141-a43f-794f14662f88.png">


### 書き込み中をみてみる
ビーコンの情報
> Module: BP108
> Version: V5.3.5
> FSC-BP108
> Inverval(ms): 1300
> TLM: False
> Pin: 000001
> TxPower(dB): 0
> Key(ms): 100 35000
> 
> 1. iBeacon
> UUID: abcdef12345678901234567890123456 ← 変更した
> Major: 10065
> Minor: 26049
> RSSI at 1m: -3
> Enable true
> ...

<img width="300" alt="Screenshot_20240216-035415.png (125.0 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/258715b9-2ec6-4a93-b653-d16e3cc6d2e1.png">


最初のパケット
OpCode: 0x52 (応答を要せず1つのValueを書き込む。)
書き込もうとしている
```
Value: 41542b42414456444154413d322c3032303130363141464634433030303231354435343644463937343735373437454642453039334532444342444430433737373530303244463042352c300d0a
```
なにを表しているかは分からない
<img width="1519" alt="スクリーンショット 2024-02-16 3.30.56.png (1.2 MB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/16508501-49da-44eb-b6a1-3dc02c215199.png">

レスポンス
```
Value: 0d0a4f4b0d0a
```
OK を含んだ文字列を返している
<img width="1519" alt="スクリーンショット 2024-02-16 3.44.34.png (1.2 MB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/3beb48c7-7d0c-4470-ac3d-a58e11170d1b.png">

#### 書き込みをした時のvalue部一覧
start [Feb 16, 2024 01:42:50.755385000 JST]
```
41542b42414456444154413d322c3032303130363141464634433030303231354435343644463937343735373437454642453039334532444342444430433737373530303244463042352c300d0a
→0d0a4f4b0d0a
```
```
41542b42414456444154413d372c30302c300d0a
→0d0a4f4b0d0a
```
```
41542b42414456444154413d342c30302c300d0a
→0d0a4f4b0d0a
```
```
41542b42414456444154413d332c30302c300d0a
→0d0a4f4b0d0a
```
```
41542b42414456444154413d362c30302c300d0a
→0d0a4f4b0d0a
```
```
41542b42414456444154413d382c30302c300d0a
→0d0a4f4b0d0a
```
```
41542b4b45594346473d3130302c33353030300d0a
→0d0a4f4b0d0a
```
```
41542b42414456444154413d302c3032303130363141464634433030303231354142434445463132333435363738393031323334353637383930313233343536323735313635433146442c310d0a
→0d0a4f4b0d0a
```
```
41542b42414456444154413d352c30302c300d0a
→0d0a4f4b0d0a
```
```
41542b42414456444154413d392c30302c300d0a
→0d0a4f4b0d0a
```
```
41542b42414456444154413d312c3032303130363033303341414645313331364141464531303042303336373646364632453637364332463530343834453533363436442c300d0a
→0d0a4f4b0d0a
```
end [Feb 16, 2024 01:42:53.515482000 JST]

### 結果
11回書き込みをしていた

リクエスト? は１つ以外は `41542b42414456444154413d3` で始まっている。
例外として `41542b4b45594346473d31303` がある

レスポンス?は全て `0d0a4f4b0d0a` となっている。

リクエストは全て `0d0a` で終わっている。
レスポンスは全て `0d0a` で始まり・終わる。これを除くと `OK` となる

<img width="1181" alt="スクリーンショット 2024-02-16 4.01.00.png (660.4 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/16/148142/5dec8209-8968-4345-855d-9766b29eadf2.png">

### 再度uuidを変えてやってみた

#### 2回目
uuid: `fdcba09876543210987654321098765`
```
41542b42414456444154413d322c3032303130363141464634433030303231354435343644463937343735373437454642453039334532444342444430433737373530303244463042352c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d372c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d342c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d332c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d362c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d382c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b4b45594346473d3130302c33353030300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d352c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d392c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d302c3032303130363141464634433030303231354645444342413039383736353433323130393837363534333231303938373635323735313635433146442c310d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d312c3032303130363033303341414645313331364141464531303042303336373646364632453637364332463530343834453533363436442c300d0a
→ 0d0a4f4b0d0a
```

#### uuid変更3回目
uuid: `abcdef12345678901234567890123456` (1回目と同じ)
```
41542b42414456444154413d322c3032303130363141464634433030303231354435343644463937343735373437454642453039334532444342444430433737373530303244463042352c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d372c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d342c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d332c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d362c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d382c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b4b45594346473d3130302c33353030300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d302c3032303130363141464634433030303231354142434445463132333435363738393031323334353637383930313233343536323735313635433146442c310d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d352c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d392c30302c300d0a
→ 0d0a4f4b0d0a
```
```
41542b42414456444154413d312c3032303130363033303341414645313331364141464531303042303336373646364632453637364332463530343834453533363436442c300d0a
→ 0d0a4f4b0d0a
```

### 差分
#### 1回目[8パケット目]
```
41542b42414456444154413d302c3032303130363141464634433030303231354142434445463132333435363738393031323334353637383930313233343536323735313635433146442c310d0a
→ 0d0a4f4b0d0a
```

#### 2回目[10パケット目]
```
41542b42414456444154413d302c3032303130363141464634433030303231354645444342413039383736353433323130393837363534333231303938373635323735313635433146442c310d0a
→ 0d0a4f4b0d0a
```

#### 3回目[8パケット目]
```
41542b42414456444154413d302c3032303130363141464634433030303231354142434445463132333435363738393031323334353637383930313233343536323735313635433146442c310d0a
→ 0d0a4f4b0d0a
```

### 差分結果
#### 1回目と3回目
uuidを変えなかった場合は同じ

#### 1,3回目と2回目
```diff
41542b42414456444154413d302c3032303130363141464634433030303231354
- 142434445463132333435363738393031323334353637383930313233343536
+ 645444342413039383736353433323130393837363534333231303938373635
323735313635433146442c310d0a
→ 0d0a4f4b0d0a
```

差は63文字, uuidは32文字

#### 同じ部分を探してみる
> 1回目: abcdef, 1234567890, 1234567890, 012345
> 2回目: fedcba, 0987654321, 0987654321, 098765

先頭部は互いに反転している
その後ろは同じものが2回+α, お互いに反転している

value を区切ってみる
```
14243444546 3 1323334353637383930 3 1323334353637383930 3 13233343536
64544434241 3 0393837363534333231 3 0393837363534333231 3 03938373635
```
3で区切るといい感じになったがuuidとvalueでは桁が合わない

#### 英字部分
```
14243444546
64544434241
```
全て間に 4 が入っている

#### 数字部分
```
1323334353637383930 3 1323334353637383930 3 13233343536
0393837363534333231 3 0393837363534333231 3 03938373635
```
全て間に 3 が入っている

2文字で一文字表しているぽいが 1桁足りないのが謎

### 最後尾だけ変えてみる
#### uuid変更 4回目
uuid: abcdef, 1234567890, 1234567890, 012341
```
142434445463132333435363738393031323334353637383930313233343531
```

#### uuid変更 4回目
uuid: abcdef, 1234567890, 1234567890, 01234a
```
142434445463132333435363738393031323334353637383930313233343541
```

### 最前部だけ変えてみる
#### uuid変更5回目
uuid: 1bcdef, 1234567890, 1234567890, 012341
切り取っていた最前部を検索かけたら引っ掛からなかった
→ 毎回同じだった1文字を切り取っていた
```
(3)142434445463132333435363738393031323334353637383930313233343541
```

64文字でuuid32文字を表している

| uuid | 送信時 |
| --- | --- |
| 0 | 30 |
| 1 | 31 |
| 2 | 32 |
| 3 | 33 |
| 4 | 34 |
| 5 | 35 |
| 6 | 36 |
| 7 | 37 |
| 8 | 38 |
| 9 | 39 |
| a | 41 |
| b | 42 |
| c | 43 |
| d | 44 |
| e | 45 |
| f | 46 |

g-z は入れられない

## 進路関係
### 転職が完了しました
ドキュメントが多くて会社の空気を実感しました
<img width="418" alt="スクリーンショット 2024-02-18 23.12.32.png (197.5 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/18/148142/55afdf7c-b6ed-4b8a-aef8-54f59713b35b.png">

時給がめっちゃ上がりました (toyamaさんありがとう)
昨年2月 976円 → 1800円
<img width="200" alt="スクリーンショット 2024-02-15 19.51.04.png (19.9 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/18/148142/2cbc1744-cce9-458b-a89f-487c1d77d63e.png">


## 余談
## 下社城に行った
登下校で真横を通るので気になっていたが、明るいうちに帰る日がなく行けなかった

<img width="4032" alt="IMG_6050.jpg (2.5 MB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/18/148142/1c564a94-71dc-49af-bd0b-0506da0f0f89.jpg">

## シス研滞在ウォッチを作った(のを手伝った)
arpスキャンをしMACアドレスから滞在者を割り出している
arpスキャンを定期実行する部分を書いた(フロント・APIは他の人)
<img width="2030" alt="image.png (96.3 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/20/148142/57ca2035-ea34-48fa-8465-d7c207046209.png">


## 自分がどこにいるかわかるサイトを作った
家にいるかは スマホのBLE を取得して判断している
<img width="3196" alt="image.png (96.1 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/20/148142/a6263d70-51d5-48c2-8246-7bca867704b1.png">


## 名簿システムのAPIを作った
18個のエントリーポイントを備えた大規模なAPIになった
JS(TS)にもデコレータがあることを知ってとても綺麗に書けた

例: 関数の前に @admin を付けると管理者は関数を実行せずにエラーを返す
<img width="1247" alt="スクリーンショット 2024-02-18 23.05.01.png (926.8 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/18/148142/ed8ac835-c0e8-48a0-b874-190d4efdf889.png">
これからフロントを完成させる
（既に5000行を超えていた）

週一でプロダクトを制作していて凄いなぁ(?)と思った


## ロボット交流会を手伝った
名電高校にて開催されたロボット交流会を手伝った
水野先生のETロボコンの展示を手伝ったが何も知らないので座っていることしか出来なかった
高校の先生・友達・後輩とおしゃべりできて良かった
<img width="45%" alt="IMG_6054.JPG (4.8 MB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/18/148142/5f3326c9-864b-4aca-93d4-fc83b0af711b.JPG">


## PC買った！！
ついにPCを買い変えた
3年半使っており熱暴走を頻発し、
登校するだけで充電が尽きるようになったので新しく買った

来年の院生のPCと同じものの JIS配列
<img width="2560" alt="2024-02-17 22.16のイメージ.jpg (159.1 kB)" src="https://img.esa.io/uploads/production/attachments/21347/2024/02/18/148142/f4ad11df-0f26-4f23-88ec-210bef919d34.jpg">

